<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>ちゃん撮れ_須ノ川のクリスマスツリーを見るブラウザAR</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

        <style type="text/css">
            #screenshot-button {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background-color: #f3f3f3;
                border: none;
                cursor: pointer;
                outline: none;
                box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
            }
        </style>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <a-scene
            renderer="logarithmicDepthBuffer: true; precision: medium;"
            embedded
            loading-screen="enabled: false;"
            vr-mode-ui="enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false;"
        >
        <a-camera gps-camera arjs-look-controls='smoothingFactor: 0.1' rotation-reader></a-camera>
<!-- バックミュージック -->
		<a-assets timeout="1000">
			<audio id="audio01" src="https://shimizukobo.github.io/sunokawa/assets/music.mp3" preload="auto"></audio>
		</a-assets>
		<a-sound id="my_sound01" src="#audio01" position="0 1.2 -3" autoplay="true" loop="true"></a-sound>

        </a-scene>
        <button id="screenshot-button"></button>

	<script>
// ユーザーに「許可」を求めるダイアログを表示
if (DeviceOrientationEvent && DeviceOrientationEvent.requestPermission &&
 typeof DeviceOrientationEvent.requestPermission === 'function'
 ) {
DeviceOrientationEvent.requestPermission();
}
	</script>

        <script src="https://shimizukobo.github.io/sunokawa/calc.js" type="module"></script>
        <script>

            document.getElementById("screenshot-button").addEventListener("click", function() {
                html2canvas(document.body).then(function(canvas) {
                    // カメラ画像を取得する為、AR.jsで展開されているvideoを取得
                    var camera = document.querySelector('video');
                    // 空のキャンバスを用意
                    var canvas = document.createElement("canvas");
                    var context = canvas.getContext("2d");
            
                    var width = camera.videoWidth;
                    var height = camera.videoHeight;

                    // A-Frameで描画しているSceneを取得
                    var aScene = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
                    // equirectangular

//alert("Save1:W"+width+"H"+height);
                    
        if (width && height) {
            //videoのサイズをキャンバスにセット
            canvas.width = width;
            canvas.height = height;
            //キャンバスにvideoをコピー
            context.drawImage(camera, 0, 0, width, height);

            //カメラの画角でar側の縮小処理を変える
            if (width > height) {
                // 横長（PC)
                context.drawImage(aScene, 0, 0, width, height);
            } else {
                // 縦長（スマホ）
                var scale = height / width;
                var scaledWidth = height * scale;
                var marginLeft = (width - scaledWidth) / 2;
                context.drawImage(aScene, marginLeft, 0, scaledWidth, height);
            }

    var now = new Date();
    var nowyear = now.getFullYear();
    var nowmon = now.getMonth()+1; //１を足すこと
    var nowday = now.getDate();
    var nowhour = now.getHours();
    var nowminutes = now.getMinutes();
    var nowseconds = now.getSeconds();

    var text = nowyear + "" +  nowmon + "" +  nowday + "_" + nowhour + nowminutes + nowseconds; 
        
alert("保存:"+text + ".jpg");

                        // jpeg画像を作成
                        // jpgの品質はデフォルト値の「0.92」とする
                        var snap = canvas.toDataURL('image/jpeg');
                        var link = document.createElement("a");
                        link.href = snap;
                        //link.download = "screenshot.jpg";
                        link.download = text + ".jpg";

                        //自動ダウンロード
                        link.click();
        }
                });
            });
        </script>
    </body>
</html>
